{% extends "base.html" %}

{% block title %}Dashboard | MoneyK{% endblock %}

{% block content %}
<div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between p-4 bg-yellow-50 rounded border border-yellow-200">
    <div class="flex flex-col md:flex-row md:items-center md:gap-6 gap-2 w-full">
        <span class="font-semibold text-yellow-700">Other Services:</span>
        <a href="https://t.me/zerovodka_bot" target="_blank" class="text-blue-700 hover:underline font-medium">LOOKUP BOT</a>
        <a href="https://t.me/zerovodka_lookup" target="_blank" class="text-blue-700 hover:underline font-medium">CHANNEL</a>
        <a href="https://t.me/zerovodka_vol2" target="_blank" class="text-blue-700 hover:underline font-medium">SUPPORT</a>
    </div>
</div>
<div class="mb-6 p-4 bg-blue-50 rounded flex flex-col md:flex-row md:items-center md:justify-between">
    <div>
        <span class="font-semibold text-gray-700">User:</span> <span class="text-blue-700">{{ user.username }}</span>
    </div>
    <div>
        <span class="font-semibold text-gray-700">Wallet Balance:</span> <span class="text-green-600">${{ wallet_balance|default:"N/A" }}</span>
    </div>
</div>

<script>
// Store processing requests info from Django context
const processingRequests = JSON.parse('{{ processing_requests_json|safe }}');
console.log('Processing Requests:', processingRequests);
// Track which requests have already been notified
const notifiedRequests = {};

function showPopup(message) {
    // Remove any existing modal
    $('#custom-status-modal').remove();

    // Overlay and modal HTML
    const html = `
        <div id="custom-status-modal" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.2);display:flex;align-items:center;justify-content:center;z-index:9999;">
        <div style="background:#fff;padding:1rem 1.5rem;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,0.12);text-align:center;min-width:220px;">
            <div style="margin-bottom:1rem;">${message}</div>
            <button id="popup-refresh-btn" style="margin:0 0.5rem;padding:0.4rem 1.2rem;background:#2563eb;color:#fff;border:none;border-radius:4px;cursor:pointer;">Refresh</button>
            <button id="popup-cancel-btn" style="margin:0 0.5rem;padding:0.4rem 1.2rem;background:#e5e7eb;color:#374151;border:none;border-radius:4px;cursor:pointer;">Cancel</button>
        </div>
        </div>
    `;
    $('body').append(html);
    $('#popup-refresh-btn').on('click', function() { window.location.reload(); });
    $('#popup-cancel-btn').on('click', function() { $('#custom-status-modal').remove(); });
}

async function checkStatuses() {
    console.log('Checking statuses for processing requests...');
    for (let i = processingRequests.length - 1; i >= 0; i--) {
        const req = processingRequests[i];
        if (req.status !== 'processing') {
            // remove from processingRequests if not processing
            processingRequests.splice(i, 1);
            continue;
        }
        try {
            const response = await fetch(`/searchbase/status/${encodeURIComponent(req.display_name)}/${req.id}/`);
            if (response.ok) {
                const data = await response.json();
                if (data.status && data.status !== 'processing' && !notifiedRequests[req.id]) {
                    notifiedRequests[req.id] = true;
                    req.status = data.status;
                    processingRequests.splice(i, 1);
                    let msg = `Request for '${req.display_name}' (ID: ${req.id}) is now '${data.status}'.`;
                    showPopup(msg);
                }
            } else if (response.status === 404) {
                // Handle 404 - remove from processing list to prevent infinite polling
                console.warn(`Request not found: ${req.display_name} (ID: ${req.id}). Removing from polling.`);
                processingRequests.splice(i, 1);
                showPopup(`Request for '${req.display_name}' (ID: ${req.id}) not found. Stopped monitoring.`);
            } else {
                console.warn(`Failed to check status for ${req.display_name} (ID: ${req.id}): ${response.status}`);
            }
        } catch (e) {
            console.error(`Error checking status for ${req.display_name} (ID: ${req.id}):`, e);
            // Remove failed requests after multiple attempts to prevent infinite polling
            if (!req.errorCount) req.errorCount = 0;
            req.errorCount++;
            if (req.errorCount >= 5) {
                console.warn(`Too many errors for ${req.display_name} (ID: ${req.id}). Removing from polling.`);
                processingRequests.splice(i, 1);
                showPopup(`Error monitoring request '${req.display_name}' (ID: ${req.id}). Stopped monitoring.`);
            }
        }
    }
}

let intervalId = null;
if (processingRequests.length > 0) {
    intervalId = setInterval(() => {
        checkStatuses();
        if (processingRequests.length === 0) {
            clearInterval(intervalId);
        }
    }, 1000);
}
</script>

<h1 class="text-2xl font-bold mb-2 text-gray-800">Welcome to your Dashboard</h1>
<p class="mb-6 text-gray-600">This is your dashboard. You can manage your account, view transactions, and more.</p>

<div class="mb-6 flex justify-end">
    <a href="{% url 'oxapay_deposit' %}" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition">
        Deposit Funds
    </a>
</div>

<h2 class="text-xl font-semibold mb-2 text-gray-700 text-center">lookup</h2>
<ul class="mb-8">
    {% for form in forms %}
        <li class="flex items-center justify-between px-3 py-1 border border-gray-200 rounded-lg mb-2 shadow-sm text-sm transition-all hover:bg-blue-50 hover:shadow cursor-pointer group" onclick="window.location.href='{% url form.url %}'">
            <span class="text-blue-700 font-medium group-hover:underline whitespace-nowrap">{{ form.name }}</span>
            {% if form.price %}
                <span class="ml-2 px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-semibold group-hover:bg-green-200">${{ form.price }}</span>
            {% endif %}
        </li>
    {% endfor %}
</ul>

<h2 class="text-xl font-semibold mb-2 text-gray-700">API Request History</h2>
<div class="overflow-x-auto">
    <table class="min-w-full bg-white rounded shadow" id="api-history-table">
        <thead class="bg-gray-100">
            <tr>
                <th class="py-2 px-4 text-left">Type</th>
                <th class="py-2 px-4 text-left">Status</th>
                <th class="py-2 px-4 text-left">Created At</th>
                <th class="py-2 px-4 text-left">Updated At</th>
                <th class="py-2 px-4 text-left">Response</th>
                <th class="py-2 px-4 text-left">Download</th>
            </tr>
        </thead>
        <tbody id="api-history-body">
            <tr><td colspan="6" class="py-4 text-center text-gray-500">Loading...</td></tr>
        </tbody>
    </table>
    <div class="flex flex-col gap-2 mt-4" id="api-history-pagination" style="display:none;">
        <div class="flex justify-between items-center">
            <button id="api-history-prev" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300" disabled>Previous</button>
            <span id="api-history-page-info" class="text-gray-700"></span>
            <button id="api-history-next" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300" disabled>Next</button>
        </div>
        <div class="flex flex-wrap justify-center gap-1" id="api-history-page-numbers"></div>
    </div>
</div>

<script>
function truncateText(text, maxLength) {
    if (!text) return '';
    return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
}

function renderApiHistory(data, page, pageSize) {
    const tbody = $('#api-history-body');
    tbody.empty();
    if (!data.results || data.results.length === 0) {
        tbody.append('<tr><td colspan="6" class="py-4 text-center text-gray-500">No API requests found.</td></tr>');
        $('#api-history-pagination').hide();
        return;
    }
    data.results.forEach(function(req) {
        let statusCell = '';
        let downloadCell = '';
        
        if (req.status === 'success') {
            statusCell = `
                <form method="post" action="/download_text_file/" style="display:inline;">
                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                    <input type="hidden" name="data" value="${req.response || ''}">
                    <input type="hidden" name="model_name" value="${req.model_name}">
                    <button type="submit" class="px-2 py-1 bg-green-500 text-white rounded" title="Download response as text file">
                        ${req.status}
                    </button>
                </form>
            `;
            downloadCell = `
                <form method="post" action="/download_text_file/" style="display:inline;">
                    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                    <input type="hidden" name="data" value="${req.response || ''}">
                    <input type="hidden" name="model_name" value="${req.model_name}">
                    <button type="submit" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition" title="Download response as text file">
                        ðŸ“¥ Download
                    </button>
                </form>
            `;
        } else {
            statusCell = req.status;
            downloadCell = '<span class="text-gray-400">-</span>';
        }
        
        tbody.append(`
            <tr class="border-b">
                <td class="py-2 px-4">${req.display_name || ''}</td>
                <td class="py-2 px-4">${statusCell}</td>
                <td class="py-2 px-4">${req.created_at ? new Date(req.created_at).toLocaleString() : ''}</td>
                <td class="py-2 px-4">${req.updated_at ? new Date(req.updated_at).toLocaleString() : ''}</td>
                <td class="py-2 px-4">${truncateText(req.response || '', 100)}</td>
                <td class="py-2 px-4">${downloadCell}</td>
            </tr>
        `);
    });
    // Pagination controls
    $('#api-history-pagination').show();
    $('#api-history-prev').prop('disabled', !data.previous);
    $('#api-history-next').prop('disabled', !data.next);
    const start = (page - 1) * pageSize + 1;
    const end = Math.min(page * pageSize, data.count);
    $('#api-history-page-info').text(`Showing ${start}-${end} of ${data.count}`);

    // Page numbers row
    const pageCount = Math.ceil(data.count / pageSize);
    const pageNumbersDiv = $('#api-history-page-numbers');
    pageNumbersDiv.empty();
    if (pageCount > 1) {
        let maxPagesToShow = 7;
        let startPage = Math.max(1, page - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(pageCount, startPage + maxPagesToShow - 1);
        if (endPage - startPage < maxPagesToShow - 1) {
            startPage = Math.max(1, endPage - maxPagesToShow + 1);
        }
        if (startPage > 1) {
            pageNumbersDiv.append(`<button class="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200" data-page="1">1</button>`);
            if (startPage > 2) pageNumbersDiv.append('<span class="px-1">...</span>');
        }
        for (let i = startPage; i <= endPage; i++) {
            if (i === page) {
                pageNumbersDiv.append(`<button class="px-2 py-1 rounded bg-blue-500 text-white font-bold" disabled>${i}</button>`);
            } else {
                pageNumbersDiv.append(`<button class="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200" data-page="${i}">${i}</button>`);
            }
        }
        if (endPage < pageCount) {
            if (endPage < pageCount - 1) pageNumbersDiv.append('<span class="px-1">...</span>');
            pageNumbersDiv.append(`<button class="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200" data-page="${pageCount}">${pageCount}</button>`);
        }
    }
}

let apiHistoryPage = 1;
let apiHistoryPageSize = 10;
let apiHistoryNextUrl = null;
let apiHistoryPrevUrl = null;

function toRelativeUrl(url) {
    if (!url) return null;
    try {
        const loc = window.location;
        const httpsBase = loc.protocol + '//' + loc.host;
        if (url.startsWith(httpsBase)) {
            return url.substring(httpsBase.length);
        } else if (url.startsWith('http://') || url.startsWith('https://')) {
            // fallback: extract path/query only
            const u = new URL(url);
            return u.pathname + u.search;
        }
        return url;
    } catch (e) {
        return url;
    }
}

function fetchApiHistory(url = null) {
    let endpoint = url ? toRelativeUrl(url) : `/api_history/?page=${apiHistoryPage}&page_size=${apiHistoryPageSize}`;
    $('#api-history-body').html('<tr><td colspan="5" class="py-4 text-center text-gray-500">Loading...</td></tr>');
    $.get(endpoint, function(data) {
        apiHistoryNextUrl = toRelativeUrl(data.next);
        apiHistoryPrevUrl = toRelativeUrl(data.previous);
        // Extract current page from next/prev URLs if available
        if (data.next) {
            const match = data.next.match(/page=(\d+)/);
            if (match) apiHistoryPage = parseInt(match[1]) - 1;
        } else if (data.previous) {
            const match = data.previous.match(/page=(\d+)/);
            if (match) apiHistoryPage = parseInt(match[1]) + 1;
        } else {
            apiHistoryPage = 1;
        }
        renderApiHistory(data, apiHistoryPage, apiHistoryPageSize);
    });
}

$(document).ready(function() {
    fetchApiHistory();
    $('#api-history-prev').on('click', function() {
        if (apiHistoryPrevUrl) fetchApiHistory(apiHistoryPrevUrl);
    });
    $('#api-history-next').on('click', function() {
        if (apiHistoryNextUrl) fetchApiHistory(apiHistoryNextUrl);
    });
    $('#api-history-page-numbers').on('click', 'button[data-page]', function() {
        const page = $(this).data('page');
        apiHistoryPage = page;
        fetchApiHistory(`/api_history/?page=${page}&page_size=${apiHistoryPageSize}`);
    });
});
</script>
{% endblock %}
